<!DOCTYPE html>
<html lang="en" data-theme="nord">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <title>JournalClub</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
</head>
<body class="min-h-screen bg-base-100 py-6 px-4">
  <!-- header.js will inject navbar -->

  <main class="max-w-4xl mx-auto mt-6">
    <div id="pageContainer">      
      <div class="text-center py-20">
        <span class="loading loading-spinner loading-lg text-primary"></span>
      </div>
    </div>
  </main>

  <footer class="mt-12 border-t border-base-200 pt-4">
    <div class="max-w-4xl mx-auto flex items-center justify-between text-sm">
      <div class="text-base-content/70">© eatyourpeas 2026</div>
      <div id="repoInfo" class="flex items-center gap-3 text-base-content/70">
        <a id="repoLink" href="https://github.com/eatyourpeas/journalclub" target="_blank" rel="noreferrer" class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5 fill-current"><path d="M12 .5C5.7.5.5 5.7.5 12c0 5.1 3.3 9.4 7.9 10.9.6.1.8-.3.8-.6v-2.1c-3.2.7-3.9-1.4-3.9-1.4-.5-1.3-1.2-1.7-1.2-1.7-1-.7.1-.7.1-.7 1.1.1 1.7 1.2 1.7 1.2 1 .1 1.6.7 1.9 1.2.2-.8.4-1.4.7-1.7-2.6-.3-5.3-1.3-5.3-6 0-1.3.5-2.3 1.2-3.1-.1-.3-.5-1.6.1-3.3 0 0 1-.3 3.3 1.2.9-.3 1.9-.5 2.9-.5s2 .2 2.9.5C17 6 18 6.3 18 6.3c.6 1.7.2 3 .1 3.3.8.8 1.2 1.8 1.2 3.1 0 4.7-2.7 5.7-5.3 6 .4.3.7 1 .7 2v3c0 .3.2.7.8.6C20.7 21.4 24 17.1 24 12c0-6.3-5.2-11.5-12-11.5z"/></svg>
          <span>eatyourpeas/journalclub</span>
        </a>
        <span id="branchSha">main • loading</span>
      </div>
    </div>
  </footer>

  <script src="config.js"></script>
  <script src="header.js"></script>
  <script>
    (function () {
      const owner = "eatyourpeas";
      const repo = "journalclub";
      const defaultBranch = "main";

      // helper to fetch target page HTML and insert main body content
      async function loadPage(page) {
        const target = page ? `${page}.html` : 'index.html';
        try {
          const res = await fetch(target, { cache: 'no-store' });
          if (!res.ok) throw new Error('Failed to fetch page: ' + res.status);
          const html = await res.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');

          // remove any scripts from fetched body and extract body content
          const fetchedBody = doc.body.cloneNode(true);
          const scripts = fetchedBody.querySelectorAll('script');
          scripts.forEach((s) => s.remove());

          const pageContainer = document.getElementById('pageContainer');
          pageContainer.innerHTML = fetchedBody.innerHTML;

          // dynamically load scripts from fetched doc (both src and inline)
          const fetchedScripts = doc.body.querySelectorAll('script');
          for (const s of fetchedScripts) {
            // avoid reloading global scripts already present in base.html
            if (s.src) {
              if (s.src.includes('header.js') || s.src.includes('config.js')) continue;
              const newScript = document.createElement('script');
              newScript.src = s.src;
              document.body.appendChild(newScript);
            } else {
              const inline = document.createElement('script');
              inline.textContent = s.textContent;
              document.body.appendChild(inline);
            }
          }
        } catch (err) {
          const pageContainer = document.getElementById('pageContainer');
          pageContainer.innerHTML = `<div class="alert alert-error">Error loading page: ${err.message}</div>`;
        }
      }

      // determine page from query param `page`
      const params = new URLSearchParams(location.search);
      const page = params.get('page');
      loadPage(page || 'index');

      // fetch repo branch/sha from GitHub API (public repo)
      async function loadRepoInfo() {
        try {
          const commitsRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/commits/${defaultBranch}`);
          if (!commitsRes.ok) throw new Error('GitHub API error');
          const commit = await commitsRes.json();
          const sha = commit.sha ? commit.sha.substring(0, 7) : 'unknown';
          document.getElementById('branchSha').textContent = `${defaultBranch} • ${sha}`;
        } catch (e) {
          document.getElementById('branchSha').textContent = `${defaultBranch} • unknown`;
        }
      }

      loadRepoInfo();
    })();
  </script>
</body>
</html>
